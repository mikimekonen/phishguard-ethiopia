import { Fragment, useEffect, useMemo, useState } from "react";
import { Header } from "@/components/layout/Header";
import { Footer } from "@/components/layout/Footer";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { MalwareVerdictBadge } from "@/components/MalwareVerdictBadge";
import { Input } from "@/components/ui/input";
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { RefreshCw } from "lucide-react";
import { useAuth } from "@/hooks/useAuth";
import { useNavigate } from "react-router-dom";
import { downloadMalwareScanPdf, fetchAdminMalwareScans, MalwareScanRow, rescanMalwareScan } from "@/lib/api";
import { cn } from "@/lib/utils";
import { useToast } from "@/hooks/use-toast";

const platforms = ["windows", "android", "pdf", "archive", "unknown"] as const;
const verdicts = ["CLEAN", "SUSPICIOUS", "MALICIOUS", "UNKNOWN"] as const;

export default function MalwareScans() {
  const { token, clear } = useAuth();
  const navigate = useNavigate();
  const [rows, setRows] = useState<MalwareScanRow[]>([]);
  const [total, setTotal] = useState(0);
  const [page, setPage] = useState(1);
  const [limit, setLimit] = useState(10);
  const [filters, setFilters] = useState({ verdict: "", platform: "", from: "", to: "" });
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [selected, setSelected] = useState<MalwareScanRow | null>(null);
  const [expandedId, setExpandedId] = useState<string | null>(null);
  const [rescanId, setRescanId] = useState<string | null>(null);
  const { toast } = useToast();

  const explainVerdict = (row: MalwareScanRow) => {
    const malicious = row.maliciousCount ?? 0;
    const suspicious = row.suspiciousCount ?? 0;
    const harmless = row.harmlessCount ?? 0;
    const provider = row.intelProvider || "External Intel";
    const isOffline = provider.toLowerCase().includes("heuristic") || provider.toLowerCase().includes("ml");

    if (row.verdict === "MALICIOUS") {
      return isOffline
        ? "Marked MALICIOUS based on static analysis and ML signals (no external intel)."
        : `Marked MALICIOUS because ${malicious} malicious detections were reported by ${provider}.`;
    }
    if (row.verdict === "SUSPICIOUS") {
      return isOffline
        ? "Marked SUSPICIOUS based on static analysis and ML signals (no external intel)."
        : `Marked SUSPICIOUS because ${suspicious} suspicious detections were reported by ${provider}.`;
    }
    if (row.verdict === "CLEAN") {
      return isOffline
        ? "Marked CLEAN because no static indicators were detected in offline analysis."
        : `Marked CLEAN because ${harmless} harmless detections were reported by ${provider}.`;
    }
    return "External intel unavailable or inconclusive.";
  };

  const totalPages = useMemo(() => Math.max(1, Math.ceil(total / limit)), [total, limit]);

  const load = async (activePage = page, activeLimit = limit, activeFilters = filters) => {
    if (!token) return;
    setLoading(true);
    setError(null);
    try {
      const res = await fetchAdminMalwareScans(token, {
        page: activePage,
        limit: activeLimit,
        verdict: (activeFilters.verdict as MalwareScanRow["verdict"]) || undefined,
        platform: (activeFilters.platform as MalwareScanRow["platform"]) || undefined,
        from: activeFilters.from || undefined,
        to: activeFilters.to || undefined,
      });
      setRows(res.rows || []);
      setTotal(res.total || 0);
    } catch (err: any) {
      setError(err.message || "Failed to load malware scans");
      if (err.message?.includes("Unauthorized")) {
        clear();
        navigate("/admin/login");
      }
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    load();
  }, [token, page, limit]);

  const handleApply = () => {
    setPage(1);
    load(1, limit, filters);
  };

  const handleClear = () => {
    const reset = { verdict: "", platform: "", from: "", to: "" };
    setFilters(reset);
    setPage(1);
    load(1, limit, reset);
  };

  const handleRescan = async (row: MalwareScanRow) => {
    if (!token) return;
    setRescanId(row.id);
    try {
      const result = await rescanMalwareScan(token, row.id);
      if (result.ok) {
        toast({
          title: "Re-analysis completed",
          description: `Verdict: ${result.verdict || row.verdict} • Risk: ${Math.round(result.riskScore ?? 0)}%`,
        });
      } else {
        toast({
          title: "Intel unavailable, verdict unchanged",
          description: result.message,
        });
      }
      await load(page, limit, filters);
    } catch (error: any) {
      toast({
        title: "Intel unavailable, verdict unchanged",
        description: error?.message || "Rescan failed",
      });
    } finally {
      setRescanId(null);
    }
  };

  const handleDownloadPdf = async (row: MalwareScanRow) => {
    if (!token) return;
    try {
      const blob = await downloadMalwareScanPdf(token, row.id);
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = `malware-${row.id}.pdf`;
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(url);
    } catch (error: any) {
      toast({
        title: "PDF export failed",
        description: error?.message || "Could not download the report",
      });
    }
  };

  return (
    <div className="min-h-screen bg-background">
      <Header />
      <main className="pt-24 pb-16">
        <div className="container mx-auto px-4 space-y-6">
          <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h1 className="text-2xl font-bold">Malware Scans</h1>
              <p className="text-sm text-muted-foreground">Admin-only malware intelligence metadata</p>
            </div>
            <Button variant="outline" onClick={() => load()} disabled={loading}>
              <RefreshCw className={cn("h-4 w-4 mr-2", loading && "animate-spin")} />
              Refresh
            </Button>
          </div>

          <Card className="bg-card/50 backdrop-blur-sm border-border">
            <CardHeader>
              <CardTitle className="text-lg">Filters</CardTitle>
            </CardHeader>
            <CardContent className="grid gap-4 md:grid-cols-4">
              <div className="space-y-1">
                <label className="text-xs text-muted-foreground">Verdict</label>
                <select
                  value={filters.verdict}
                  onChange={(e) => setFilters((prev) => ({ ...prev, verdict: e.target.value }))}
                  className="w-full rounded-lg border border-border bg-muted/50 px-3 py-2 text-sm"
                >
                  <option value="">All</option>
                  {verdicts.map((v) => (
                    <option key={v} value={v}>
                      {v}
                    </option>
                  ))}
                </select>
              </div>
              <div className="space-y-1">
                <label className="text-xs text-muted-foreground">Platform</label>
                <select
                  value={filters.platform}
                  onChange={(e) => setFilters((prev) => ({ ...prev, platform: e.target.value }))}
                  className="w-full rounded-lg border border-border bg-muted/50 px-3 py-2 text-sm"
                >
                  <option value="">All</option>
                  {platforms.map((p) => (
                    <option key={p} value={p}>
                      {p}
                    </option>
                  ))}
                </select>
              </div>
              <div className="space-y-1">
                <label className="text-xs text-muted-foreground">From</label>
                <Input type="date" value={filters.from} onChange={(e) => setFilters((prev) => ({ ...prev, from: e.target.value }))} />
              </div>
              <div className="space-y-1">
                <label className="text-xs text-muted-foreground">To</label>
                <Input type="date" value={filters.to} onChange={(e) => setFilters((prev) => ({ ...prev, to: e.target.value }))} />
              </div>
              <div className="flex items-center gap-2">
                <Button variant="outline" size="sm" onClick={handleApply}>
                  Apply
                </Button>
                <Button variant="ghost" size="sm" onClick={handleClear}>
                  Clear
                </Button>
              </div>
            </CardContent>
          </Card>

          <Card className="bg-card/50 backdrop-blur-sm border-border">
            <CardHeader>
              <CardTitle className="text-lg">Scan Results</CardTitle>
            </CardHeader>
            <CardContent>
              {loading ? (
                <div className="space-y-3">
                  {Array.from({ length: 5 }).map((_, idx) => (
                    <div key={idx} className="h-12 rounded-lg bg-muted/40 animate-pulse" />
                  ))}
                </div>
              ) : error ? (
                <div className="text-sm text-destructive flex items-center justify-between">
                  {error}
                  <Button variant="outline" size="sm" onClick={() => load()}>
                    Retry
                  </Button>
                </div>
              ) : rows.length === 0 ? (
                <div className="text-sm text-muted-foreground">No malware scans found.</div>
              ) : (
                <div className="overflow-auto">
                  <table className="w-full text-sm">
                    <thead className="text-left text-muted-foreground">
                      <tr>
                        <th className="py-2">File Name</th>
                        <th className="py-2">Verdict</th>
                        <th className="py-2">Malware Family</th>
                        <th className="py-2">Confidence</th>
                        <th className="py-2">Platform</th>
                        <th className="py-2">Source</th>
                        <th className="py-2">Scan Date</th>
                        <th className="py-2">Actions</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-border">
                      {rows.map((row) => (
                        <Fragment key={row.id}>
                          <tr
                            className="cursor-pointer hover:bg-muted/30"
                            onClick={() => setSelected(row)}
                          >
                            <td className="py-3 pr-4 max-w-[220px] truncate">{row.fileName || "Unknown file"}</td>
                            <td className="py-3">
                              <div className="flex flex-col gap-2">
                                <MalwareVerdictBadge verdict={row.verdict} />
                                <button
                                  className="text-xs text-primary underline-offset-4 hover:underline"
                                  onClick={(event) => {
                                    event.stopPropagation();
                                    setExpandedId((current) => (current === row.id ? null : row.id));
                                  }}
                                >
                                  {expandedId === row.id ? "Hide Details" : "View Details"}
                                </button>
                              </div>
                            </td>
                            <td className="py-3 text-muted-foreground">{row.malwareFamily || "—"}</td>
                            <td className="py-3">{row.confidenceScore}%</td>
                            <td className="py-3">{row.platform}</td>
                            <td className="py-3">{row.source}</td>
                            <td className="py-3">{new Date(row.createdAt).toLocaleString()}</td>
                            <td className="py-3">
                              <Button
                                variant="outline"
                                size="sm"
                                disabled={rescanId === row.id}
                                onClick={(event) => {
                                  event.stopPropagation();
                                  handleRescan(row);
                                }}
                              >
                                {rescanId === row.id ? "Re-analyzing..." : "Re-analyze"}
                              </Button>
                            </td>
                          </tr>
                          {expandedId === row.id && (
                            <tr className="bg-muted/20">
                              <td colSpan={8} className="pb-4">
                                <div className="mt-3 rounded-xl border border-border bg-card/60 p-4 text-sm">
                                  <div className="flex flex-wrap items-center gap-3">
                                    <MalwareVerdictBadge verdict={row.verdict} />
                                    <span className="text-xs text-muted-foreground">
                                      Provider: {row.intelProvider || "External Intel"}
                                    </span>
                                    <span className="text-xs text-muted-foreground">
                                      Scanned: {new Date(row.scannedAt || row.createdAt).toLocaleString()}
                                    </span>
                                  </div>

                                  <div className="mt-3">
                                    <div className="flex items-center justify-between text-xs text-muted-foreground">
                                      <span>Risk score</span>
                                      <span>{Math.round(row.riskScore ?? 0)}%</span>
                                    </div>
                                    <div className="mt-1 h-2 rounded-full bg-muted">
                                      <div
                                        className="h-2 rounded-full bg-primary"
                                        style={{ width: `${Math.max(0, Math.min(100, Math.round(row.riskScore ?? 0)))}%` }}
                                      />
                                    </div>
                                  </div>

                                  <div className="mt-3 grid gap-2 md:grid-cols-2">
                                    <div className="rounded-lg border border-border/60 bg-background/60 p-3">
                                      <div className="text-xs text-muted-foreground">Malicious detections</div>
                                      <div className="text-sm font-semibold">{row.maliciousCount ?? 0}</div>
                                    </div>
                                    <div className="rounded-lg border border-border/60 bg-background/60 p-3">
                                      <div className="text-xs text-muted-foreground">Suspicious detections</div>
                                      <div className="text-sm font-semibold">{row.suspiciousCount ?? 0}</div>
                                    </div>
                                    <div className="rounded-lg border border-border/60 bg-background/60 p-3">
                                      <div className="text-xs text-muted-foreground">Harmless detections</div>
                                      <div className="text-sm font-semibold">{row.harmlessCount ?? 0}</div>
                                    </div>
                                  </div>

                                  <p className="mt-3 text-sm text-muted-foreground">
                                    {explainVerdict(row)}
                                  </p>
                                </div>
                              </td>
                            </tr>
                          )}
                        </Fragment>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}

              <div className="mt-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                <div className="text-xs text-muted-foreground">
                  Page {page} of {totalPages} • {total} total
                </div>
                <div className="flex items-center gap-2">
                  <Button variant="outline" size="sm" disabled={page <= 1} onClick={() => setPage((p) => Math.max(1, p - 1))}>
                    Prev
                  </Button>
                  <Button variant="outline" size="sm" disabled={page >= totalPages} onClick={() => setPage((p) => Math.min(totalPages, p + 1))}>
                    Next
                  </Button>
                  <select
                    value={limit}
                    onChange={(e) => {
                      setLimit(Number(e.target.value));
                      setPage(1);
                    }}
                    className="rounded-lg border border-border bg-muted/50 px-2 py-1 text-xs"
                  >
                    {[10, 25, 50].map((size) => (
                      <option key={size} value={size}>
                        {size} rows
                      </option>
                    ))}
                  </select>
                </div>
              </div>
            </CardContent>
          </Card>
        </div>
      </main>
      <Footer />

      <Dialog open={!!selected} onOpenChange={() => setSelected(null)}>
        <DialogContent className="max-w-xl">
          <DialogHeader>
            <DialogTitle>Malware Scan Details</DialogTitle>
          </DialogHeader>
          {selected && (
            <div className="space-y-3 text-sm">
              <div className="flex items-center gap-2">
                <MalwareVerdictBadge verdict={selected.verdict} />
                <span className="text-muted-foreground">Confidence: {selected.confidenceScore}%</span>
                <Button variant="outline" size="sm" onClick={() => handleDownloadPdf(selected)}>
                  Download PDF
                </Button>
              </div>
              <div><span className="text-muted-foreground">File Name:</span> {selected.fileName || "Unknown"}</div>
              <div><span className="text-muted-foreground">File Hash:</span> {selected.fileHash}</div>
              <div><span className="text-muted-foreground">MD5:</span> {selected.md5 || "—"}</div>
              <div><span className="text-muted-foreground">SHA1:</span> {selected.sha1 || "—"}</div>
              <div><span className="text-muted-foreground">File Size:</span> {selected.fileSize ? `${selected.fileSize.toLocaleString()} bytes` : "—"}</div>
              <div><span className="text-muted-foreground">Type Description:</span> {selected.fileTypeDescription || "—"}</div>
              <div><span className="text-muted-foreground">Family:</span> {selected.malwareFamily || "—"}</div>
              <div><span className="text-muted-foreground">Type:</span> {selected.malwareType || "—"}</div>
              <div><span className="text-muted-foreground">Threat Label:</span> {selected.threatLabel || "—"}</div>
              <div>
                <span className="text-muted-foreground">Threat Tags:</span>{" "}
                {selected.threatTags?.length ? selected.threatTags.join(", ") : "—"}
              </div>
              <div><span className="text-muted-foreground">Entropy:</span> {typeof selected.entropy === "number" ? selected.entropy.toFixed(2) : "—"}</div>
              <div>
                <span className="text-muted-foreground">Suspicious Strings:</span>{" "}
                {selected.suspiciousStrings?.length ? selected.suspiciousStrings.slice(0, 6).join(", ") : "—"}
              </div>
              <div>
                <span className="text-muted-foreground">Detection Engines:</span>{" "}
                {selected.detectionEngines?.length ? `${selected.detectionEngines.length} engines` : "—"}
              </div>
              <div>
                <span className="text-muted-foreground">Detection Timestamp:</span>{" "}
                {selected.detectionTimestamp ? new Date(selected.detectionTimestamp).toLocaleString() : "—"}
              </div>
              <div><span className="text-muted-foreground">Platform:</span> {selected.platform}</div>
              <div><span className="text-muted-foreground">Source:</span> {selected.source}</div>
              <div><span className="text-muted-foreground">Provider:</span> {selected.intelProvider || "External Intel"}</div>
              <div><span className="text-muted-foreground">File Type:</span> {selected.fileType || "—"}</div>
              <div><span className="text-muted-foreground">Scan Date:</span> {new Date(selected.createdAt).toLocaleString()}</div>
              <div>
                <span className="text-muted-foreground">Behavior:</span> {selected.behaviorDescription || "—"}
              </div>
              <div>
                <span className="text-muted-foreground">Impact:</span> {selected.impactDescription || "—"}
              </div>
              <div>
                <span className="text-muted-foreground">Mitigation:</span> {selected.mitigationSuggestions || "—"}
              </div>
              <div>
                <span className="text-muted-foreground">መግለጫ (AM):</span> {selected.descriptionAm || "—"}
              </div>
              <div>
                <span className="text-muted-foreground">IOCs:</span>{" "}
                {selected.iocs ? JSON.stringify(selected.iocs) : "—"}
              </div>
              <div>
                <span className="text-muted-foreground">Static Features:</span>{" "}
                {selected.staticFeatures ? JSON.stringify(selected.staticFeatures) : "—"}
              </div>
              <div>
                <span className="text-muted-foreground">Dynamic Features:</span>{" "}
                {selected.dynamicFeatures ? JSON.stringify(selected.dynamicFeatures) : "—"}
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>
    </div>
  );
}
