import { ShieldAlert, ShieldCheck, AlertTriangle, BadgeCheck } from "lucide-react";
import { Button } from "@/components/ui/button";
import { cn } from "@/lib/utils";
import { MalwareVerdictBadge } from "@/components/MalwareVerdictBadge";

export type MalwareResultData = {
  verdict: "CLEAN" | "SUSPICIOUS" | "MALICIOUS" | "UNKNOWN";
  verdictLabel?: string;
  verdictLabelAm?: string;
  confidenceBand?: "safe" | "suspicious" | "malware";
  confidence: number;
  malwareFamily?: string;
  behaviorSummary?: string;
  warning?: string;
  warningAm?: string;
  sourceLabel?: string;
};

interface MalwareResultProps {
  result: MalwareResultData;
  onReset: () => void;
}

export function MalwareResult({ result, onReset }: MalwareResultProps) {
  const confidence = Math.max(0, Math.min(100, Math.round(result.confidence)));
  const scoreBand = result.verdict === "MALICIOUS"
    ? "malware"
    : result.verdict === "SUSPICIOUS"
    ? "suspicious"
    : result.verdict === "CLEAN"
    ? "safe"
    : result.confidenceBand || (confidence <= 20 ? "safe" : confidence <= 70 ? "suspicious" : "malware");
  const verdictLabel = result.verdictLabel
    || (scoreBand === "malware" ? "Malware Detected" : scoreBand === "suspicious" ? "Suspicious" : "Safe / Low confidence");
  const verdictLabelAm = result.verdictLabelAm
    || (scoreBand === "malware" ? "ማልዌር ተገኘ" : scoreBand === "suspicious" ? "ጥርጣሬ ያለ" : "ደህንነት / ዝቅተኛ እምነት");
  const description =
    scoreBand === "malware"
      ? {
          en: "High confidence of malicious indicators. Do not open or share this file.",
          am: "ከፍተኛ እምነት ያለ ጉዳተኛ ምልክት ተገኝቷል። ፋይሉን አትክፈቱ እና አትተላለፉት።",
        }
      : scoreBand === "suspicious"
      ? {
          en: "Signals are mixed or limited. Verify the source before opening.",
          am: "ምልክቶቹ ድብልቅ ወይም አነስተኛ ናቸው። ምንጩን አረጋግጡ በፊት ክፈቱ።",
        }
      : {
          en: "Low confidence of risk. Continue with caution and verify the source when possible.",
          am: "የአደጋ እምነት ዝቅተኛ ነው። ሆኖም በተቻለ መጠን ምንጩን ያረጋግጡ።",
        };
  const behaviorSummaryAm = result.behaviorSummary
    ? scoreBand === "malware"
      ? "የጉዳተኛ ባህሪ ምልክቶች ተገኝተዋል።"
      : scoreBand === "suspicious"
      ? "ምልክቶቹ አልበቃም ወይም ግልጽ አይደሉም።"
      : "ጥርጣሬ ያለ ባህሪ አልታየም።"
    : "ጥርጣሬ ያለ ባህሪ አልታየም።";
  const warningAm = result.warningAm
    ? result.warningAm
    : result.warning
    ? scoreBand === "malware"
      ? "ይህ ፋይል ማልዌር ነው። አትክፈቱ እና አትተላለፉት።"
      : scoreBand === "suspicious"
      ? "በመክፈት በፊት ምንጩን ያረጋግጡ።"
      : "ጉዳተኛ ምልክት አልታየም፣ ነገር ግን ምንጩን ሁልጊዜ ያረጋግጡ።"
    : undefined;
  const badgeStyle = scoreBand === "malware"
    ? "bg-destructive/15 text-destructive"
    : scoreBand === "suspicious"
    ? "bg-warning/20 text-warning"
    : "bg-success/20 text-success";

  return (
    <div className="space-y-5 animate-fade-in">
      <div className={cn("p-6 rounded-2xl border-2", scoreBand === "malware" ? "border-destructive/60 bg-destructive/5" : scoreBand === "suspicious" ? "border-warning/50 bg-warning/5" : "border-success/50 bg-success/5")}>
        <div className="flex items-start gap-4">
          <div className={cn("p-3 rounded-xl", scoreBand === "malware" ? "bg-destructive/20" : scoreBand === "suspicious" ? "bg-warning/20" : "bg-success/20")}>
            {scoreBand === "malware" ? (
              <ShieldAlert className="h-8 w-8 text-destructive" />
            ) : scoreBand === "suspicious" ? (
              <AlertTriangle className="h-8 w-8 text-warning" />
            ) : (
              <ShieldCheck className="h-8 w-8 text-success" />
            )}
          </div>
          <div className="flex-1">
            <div className="flex flex-wrap items-center gap-3">
              <h3 className="text-xl font-semibold">{verdictLabel}</h3>
              <span className="text-xs text-muted-foreground">({verdictLabelAm})</span>
              <MalwareVerdictBadge verdict={result.verdict} />
              <span className={cn("text-xs px-2 py-0.5 rounded-full", badgeStyle)}>{confidence}% confidence</span>
            </div>
            <p className="text-sm text-muted-foreground mt-1">{result.sourceLabel || "External Malware Intelligence Result"}</p>
            <div className="mt-2 text-sm text-muted-foreground">
              <p>{description.en}</p>
              <p className="mt-1 text-secondary">{description.am}</p>
            </div>
            {result.warning && (
              <div className="mt-3 text-sm text-destructive font-medium">
                <p>{result.warning}</p>
                {warningAm && <p className="text-secondary mt-1">{warningAm}</p>}
              </div>
            )}
          </div>
        </div>
      </div>

      <div className="grid gap-4 md:grid-cols-2">
        <div className="p-4 rounded-xl border border-border bg-card/60">
          <div className="flex items-center gap-2 text-sm font-semibold mb-1">
            <BadgeCheck className="h-4 w-4 text-primary" />
            Malware Family
          </div>
          <div className="text-xs text-muted-foreground mb-2">የማልዌር ቤተሰብ</div>
          <p className="text-sm text-muted-foreground">
            {result.malwareFamily || "No malware family detected."}
          </p>
        </div>
        <div className="p-4 rounded-xl border border-border bg-card/60">
          <div className="flex items-center gap-2 text-sm font-semibold mb-1">
            <AlertTriangle className="h-4 w-4 text-primary" />
            Static Analysis Summary
          </div>
          <div className="text-xs text-muted-foreground mb-2">የስታቲክ ትንተና ማጠቃለያ</div>
          <p className="text-sm text-muted-foreground">
            {result.behaviorSummary || "No suspicious behavior observed."}
          </p>
          <p className="text-sm text-secondary mt-1">{behaviorSummaryAm}</p>
        </div>
      </div>

      <Button variant="outline" className="w-full" onClick={onReset}>
        Scan another file
      </Button>
    </div>
  );
}
