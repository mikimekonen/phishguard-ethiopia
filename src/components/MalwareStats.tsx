import { useMemo, useState } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import type { MalwareStatsPayload } from "@/lib/api";

const verdictColors = {
  CLEAN: "bg-[#16a34a]",
  SUSPICIOUS: "bg-[#f59e0b]",
  MALICIOUS: "bg-[#dc2626]",
  UNKNOWN: "bg-[#6b7280]",
};

const verdictText = {
  CLEAN: "CLEAN",
  SUSPICIOUS: "SUSPICIOUS",
  MALICIOUS: "MALICIOUS",
  UNKNOWN: "UNKNOWN",
};

type MalwareStatsProps = {
  data: MalwareStatsPayload | null;
};

export function MalwareStats({ data }: MalwareStatsProps) {
  const [range, setRange] = useState<"daily" | "weekly">("daily");

  const totals = useMemo(() => {
    if (!data) return { total: 0, malware: 0, highRisk: 0, avgRisk: 0 };
    return {
      total: data.total || 0,
      malware: data.verdicts.MALICIOUS || 0,
      highRisk: data.highRiskScans || 0,
      avgRisk: data.averageRiskScore || 0,
    };
  }, [data]);

  const verdictRows = useMemo(() => {
    if (!data) return [];
    const total = data.total || 0;
    return (Object.keys(data.verdicts) as Array<keyof MalwareStatsPayload["verdicts"]>).map((key) => {
      const count = data.verdicts[key] || 0;
      const percent = total > 0 ? Math.round((count / total) * 100) : 0;
      return { key, count, percent };
    });
  }, [data]);

  const trend = useMemo(() => {
    if (!data) return [] as Array<{ label: string; counts: MalwareStatsPayload["verdicts"] }>;
    if (range === "weekly") {
      return data.trends.weekly.map((item) => ({
        label: item.weekStart,
        counts: item.counts,
      }));
    }
    return data.trends.daily.map((item) => ({
      label: item.date,
      counts: item.counts,
    }));
  }, [data, range]);

  const trendTotals = trend.map((item) =>
    item.counts.CLEAN + item.counts.SUSPICIOUS + item.counts.MALICIOUS + item.counts.UNKNOWN,
  );
  const maxTrend = Math.max(1, ...trendTotals);

  if (!data || data.total === 0) {
    return (
      <Card className="bg-card/50 backdrop-blur-sm border-border">
        <CardHeader>
          <CardTitle className="text-lg">Malware Statistics</CardTitle>
        </CardHeader>
        <CardContent>
          <p className="text-sm text-muted-foreground">No data available.</p>
        </CardContent>
      </Card>
    );
  }

  return (
    <div className="space-y-6">
      <Card className="bg-card/50 backdrop-blur-sm border-border">
        <CardHeader>
          <CardTitle className="text-lg">Malware Statistics</CardTitle>
        </CardHeader>
        <CardContent className="grid grid-cols-1 md:grid-cols-4 gap-4">
          {[
            { label: "Total Malware Scans", value: totals.total },
            { label: "Confirmed Malware", value: totals.malware, color: "text-[#dc2626]" },
            { label: "High-Risk Scans", value: totals.highRisk, color: "text-[#f59e0b]" },
            { label: "Average Risk Score", value: `${totals.avgRisk}%`, color: "text-primary" },
          ].map((stat) => (
            <div key={stat.label} className="rounded-xl border border-border bg-muted/30 p-4">
              <p className="text-xs text-muted-foreground">{stat.label}</p>
              <p className={`text-2xl font-semibold ${stat.color || "text-foreground"}`}>{stat.value}</p>
            </div>
          ))}
        </CardContent>
        <CardContent className="pt-0 text-xs text-muted-foreground">
          Last updated: {new Date(data.lastUpdated).toLocaleString()}
        </CardContent>
      </Card>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <Card className="bg-card/50 backdrop-blur-sm border-border">
          <CardHeader>
            <CardTitle className="text-lg">Verdict Distribution</CardTitle>
          </CardHeader>
          <CardContent className="space-y-3">
            {verdictRows.map((row) => (
              <div key={row.key} className="space-y-1">
                <div className="flex items-center justify-between text-xs text-muted-foreground">
                  <span className="font-medium text-foreground">{verdictText[row.key]}</span>
                  <span>
                    {row.count} â€¢ {row.percent}%
                  </span>
                </div>
                <div className="h-2 rounded-full bg-muted">
                  <div
                    className={`h-2 rounded-full ${verdictColors[row.key]}`}
                    style={{ width: `${row.percent}%` }}
                    aria-label={`${verdictText[row.key]} ${row.percent}%`}
                  />
                </div>
              </div>
            ))}
          </CardContent>
        </Card>

        <Card className="bg-card/50 backdrop-blur-sm border-border">
          <CardHeader className="flex flex-row items-center justify-between">
            <CardTitle className="text-lg">Scan Trends</CardTitle>
            <div className="flex items-center gap-2 text-xs">
              <button
                className={`rounded-full px-3 py-1 ${range === "daily" ? "bg-primary/10 text-primary" : "text-muted-foreground"}`}
                onClick={() => setRange("daily")}
              >
                Daily
              </button>
              <button
                className={`rounded-full px-3 py-1 ${range === "weekly" ? "bg-primary/10 text-primary" : "text-muted-foreground"}`}
                onClick={() => setRange("weekly")}
              >
                Weekly
              </button>
            </div>
          </CardHeader>
          <CardContent>
            <div className="flex items-end gap-2 h-28">
              {trend.map((item, idx) => {
                const total = trendTotals[idx] || 1;
                const cleanPct = (item.counts.CLEAN / total) * 100;
                const suspiciousPct = (item.counts.SUSPICIOUS / total) * 100;
                const malwarePct = (item.counts.MALICIOUS / total) * 100;
                const unknownPct = (item.counts.UNKNOWN / total) * 100;

                const heightPct = (total / maxTrend) * 100;
                return (
                  <div key={item.label} className="flex-1 flex items-end">
                    <div className="w-full rounded-md bg-muted/40" style={{ height: `${heightPct}%` }}>
                      <div className="flex h-full flex-col">
                        <div className={verdictColors.CLEAN} style={{ height: `${cleanPct}%` }} />
                          <div className={verdictColors.SUSPICIOUS} style={{ height: `${suspiciousPct}%` }} />
                          <div className={verdictColors.MALICIOUS} style={{ height: `${malwarePct}%` }} />
                        <div className={verdictColors.UNKNOWN} style={{ height: `${unknownPct}%` }} />
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
            <div className="mt-2 grid grid-cols-2 text-xs text-muted-foreground">
              <span>Min: 0</span>
              <span className="text-right">Max: {maxTrend}</span>
            </div>
          </CardContent>
        </Card>
      </div>

      <Card className="bg-card/50 backdrop-blur-sm border-border">
        <CardHeader>
          <CardTitle className="text-lg">Intel Provider Breakdown</CardTitle>
        </CardHeader>
        <CardContent>
          {data.intelProviders.length ? (
            <div className="space-y-2">
              {data.intelProviders.map((provider) => (
                <div key={provider.provider} className="flex items-center justify-between text-sm">
                  <span className="text-muted-foreground">{provider.provider}</span>
                  <span className="font-semibold text-foreground">{provider.count}</span>
                </div>
              ))}
            </div>
          ) : (
            <p className="text-sm text-muted-foreground">No intel provider data available.</p>
          )}
        </CardContent>
      </Card>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <Card className="bg-card/50 backdrop-blur-sm border-border">
          <CardHeader>
            <CardTitle className="text-lg">Top Malware Families</CardTitle>
          </CardHeader>
          <CardContent>
            {data.topFamilies.length ? (
              <div className="space-y-2">
                {data.topFamilies.map((item) => (
                  <div key={item.name} className="flex items-center justify-between text-sm">
                    <span className="text-muted-foreground">{item.name}</span>
                    <span className="font-semibold text-foreground">{item.count}</span>
                  </div>
                ))}
              </div>
            ) : (
              <p className="text-sm text-muted-foreground">No malware family data available.</p>
            )}
          </CardContent>
        </Card>

        <Card className="bg-card/50 backdrop-blur-sm border-border">
          <CardHeader>
            <CardTitle className="text-lg">Top Malware Types</CardTitle>
          </CardHeader>
          <CardContent>
            {data.topTypes.length ? (
              <div className="space-y-2">
                {data.topTypes.map((item) => (
                  <div key={item.name} className="flex items-center justify-between text-sm">
                    <span className="text-muted-foreground">{item.name}</span>
                    <span className="font-semibold text-foreground">{item.count}</span>
                  </div>
                ))}
              </div>
            ) : (
              <p className="text-sm text-muted-foreground">No malware type data available.</p>
            )}
          </CardContent>
        </Card>

        <Card className="bg-card/50 backdrop-blur-sm border-border">
          <CardHeader>
            <CardTitle className="text-lg">Top Threat Labels</CardTitle>
          </CardHeader>
          <CardContent>
            {data.topThreatLabels.length ? (
              <div className="space-y-2">
                {data.topThreatLabels.map((item) => (
                  <div key={item.name} className="flex items-center justify-between text-sm">
                    <span className="text-muted-foreground">{item.name}</span>
                    <span className="font-semibold text-foreground">{item.count}</span>
                  </div>
                ))}
              </div>
            ) : (
              <p className="text-sm text-muted-foreground">No threat label data available.</p>
            )}
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
